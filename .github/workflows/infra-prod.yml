name: MANUAL Deploy Production Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Confirma o deploy da infraestrutura? (Digite "CONFIRMO" para continuar)'
        required: true
        default: ''
      action:
        description: 'A√ß√£o do Terraform'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

env:
  REGISTRY: docker.io
  REGISTRY_NAME: brunovn7
  CLUSTER_NAME: listapro-prod-cluster

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
    - name: Validate Confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_deployment }}" != "CONFIRMO" ]; then
          echo "‚ùå Deploy cancelado. Digite 'CONFIRMO' para confirmar o deploy da infraestrutura."
          exit 1
        fi
        echo "‚úÖ Confirma√ß√£o v√°lida. Prosseguindo com o deploy da infraestrutura..."

  infrastructure-production:
    runs-on: ubuntu-latest
    needs: validate-input
    environment: production
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false

    - name: üåä Setup DigitalOcean
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_TOKEN }}

    - name: ‚öôÔ∏è Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.29.0'

    - name: üîç Get Available Kubernetes Versions
      run: |
        echo "Available Kubernetes versions:"
        doctl kubernetes options versions
        echo "Latest version:"
        doctl kubernetes options versions --output json | jq -r '.[0].slug'

    # Deploy Infrastructure usando script inteligente
    - name: üöÄ Deploy Production Infrastructure
      run: |
        chmod +x scripts/universal-deploy.sh
        chmod +x scripts/smart-deploy-do.sh
        
        # Set environment variables for production deployment
        export DIGITALOCEAN_TOKEN="${{ secrets.DIGITALOCEAN_TOKEN }}"
        export SKIP_CONFIRM=1
        
        # Run smart deployment for production
        ./scripts/universal-deploy.sh digitalocean production ${{ github.event.inputs.action }}

    - name: üîß Configure kubectl for Production Cluster
      if: github.event.inputs.action == 'apply'
      run: |
        # Get cluster name and configure kubectl
        CLUSTER_NAME="${{ env.CLUSTER_NAME }}"
        echo "Configuring kubectl for cluster: $CLUSTER_NAME"
        doctl kubernetes cluster kubeconfig save "$CLUSTER_NAME"
        
        # Verify cluster connection
        kubectl cluster-info
        kubectl get nodes

    - name: üìä Install Basic Infrastructure
      if: github.event.inputs.action == 'apply'
      run: |
        # Install basic infrastructure if scripts exist
        if [ -f "scripts/install-simple-infrastructure-no-traefik.sh" ]; then
          chmod +x scripts/install-simple-infrastructure-no-traefik.sh
          ./scripts/install-simple-infrastructure-no-traefik.sh
        fi
        
        # Clean orphaned webhooks if script exists
        if [ -f "scripts/clean-orphaned-webhooks.sh" ]; then
          chmod +x scripts/clean-orphaned-webhooks.sh
          ./scripts/clean-orphaned-webhooks.sh
        fi
      continue-on-error: true

    - name: üìã Production Infrastructure Summary
      run: |
        echo "üéâ Production Infrastructure action completed!"
        echo "Cloud: Digital Ocean"
        echo "Environment: production"
        echo "Action: ${{ github.event.inputs.action }}"
        echo "Registry: Docker Hub (${{ env.REGISTRY_NAME }})"
        echo "Cluster: ${{ env.CLUSTER_NAME }}"
        echo ""
        echo "üîó Next steps:"
        echo "1. Run the build-prod pipeline for application deployment"
        echo "2. Test the production environment"
        echo "3. Monitor application performance"
        echo ""
        echo "üîß Useful commands:"
        echo "doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}"
        echo "kubectl get pods -n listapro-prod"
        echo "kubectl get services -n listapro-prod"
